# Implementation Plan: ENG-26 Email Integration (SES)

## Overview
ENG-26 is the final MVP feature - integrating AWS SES for email campaign sending. This builds on existing email campaign infrastructure (create form, send logic) and adds SES-specific configuration, credential management, and email sending.

## Implementation Strategy

### Phase 1: Backend Infrastructure (40% of work)
1. **Database Schema Updates**
   - Update `tenant_channel_settings` to store encrypted SES credentials
   - Add fields: `aws_access_key_id`, `aws_secret_access_key`, `ses_region`, `verified_sender_email`, `is_connected`
   - Ensure encryption key is set via environment variable

2. **SES Configuration API**
   - `POST /api/tenant/channels/email` - Save SES credentials
     - Validate AWS credentials by making test API call
     - Encrypt credentials before storage
     - Return status and verified email list
   - `GET /api/tenant/channels/email` - Get current configuration
     - Return status, region, verified email (never return full keys)
   - `DELETE /api/tenant/channels/email` - Disconnect SES
   - `GET /api/tenant/channels/email/verified-emails` - List verified senders from AWS

3. **Email Sending Service**
   - Create `backend/src/services/emailService.js`
   - Implement `sendEmail(contactEmail, subject, htmlBody, textBody, senderEmail)`
   - Call AWS SES SendEmail API
   - Handle rate limiting (14 emails/sec)
   - Return provider_message_id for tracking
   - Proper error handling and retry logic

4. **Email Queue Processing**
   - Update message queue processor to handle email messages
   - For each queued email message:
     - Call sendEmail()
     - Store provider_message_id
     - Update status to "sent"
     - On error: retry up to 3 times, then mark "failed"

5. **Webhook Handler for SES**
   - Extend `POST /webhooks/email` to process SES notifications
   - Handle bounce, complaint, delivery, open, click events
   - Update message status correctly
   - Broadcast metrics updates via SSE

### Phase 2: Frontend UI (60% of work)
1. **Email Settings Page**
   - Navigate to /settings/channels
   - Add Email (SES) Configuration section
   - Input form with fields:
     - AWS Access Key ID
     - AWS Secret Access Key
     - SES Region (dropdown: us-east-1, eu-west-1, etc.)
     - Verified sender email (dropdown or input)
   - "Connect to SES" button
   - Connection status display (green/red indicator)
   - List of verified emails from AWS account
   - "Refresh" button to pull latest from AWS

2. **Email Campaign Sending**
   - Update campaign creation form to support email channel
   - When sending email campaign:
     - Check if SES is configured (error if not)
     - Send email messages via queue
     - Update campaign status to "sending"
     - Show metrics in real-time via SSE

### Phase 3: Testing & Validation
- Verify SES configuration saves and encrypts credentials
- Test email sending with mock/test AWS account
- Verify webhook handling for SES events
- Test metrics updates for email campaigns
- Ensure no console errors or security issues

## Implementation Order
1. Update database schema (if needed)
2. Create email service with SES integration
3. Implement SES configuration API endpoints
4. Add email handling to webhook processor
5. Update email queue processing
6. Build frontend settings page
7. Test end-to-end workflow
8. Clean up and verify all features

## Key Decisions
- **Security**: Use environment variable for encryption key (never commit)
- **Credentials**: Store encrypted, never log or expose to frontend
- **Rate Limiting**: Respect AWS SES 14 emails/sec limit with queue backoff
- **Testing**: Use AWS SES test credentials (dev account)
- **Fallback**: If SES not configured, show error on campaign send

## Success Criteria
- ✅ Email campaigns can be sent via SES
- ✅ MessageId stored for tracking
- ✅ Message status updates correctly
- ✅ Metrics show email delivery/open rates
- ✅ No console errors
- ✅ Credentials properly encrypted
- ✅ Webhook events processed correctly
